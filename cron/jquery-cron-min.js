/*
 * jQuery gentleSelect plugin
 * Forked from: http://shawnchin.github.com/jquery-cron
 * To: https://github.com/Gidgidonihah/jquery-cron
 *
 * Copyright (c) 2010 Shawn Chin.
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Requires:
 * - jQuery
 * - jQuery gentleSelect plugin
 *
 * Usage:
 *  (JS)
 *
 *  // initialise like this
 *  var c = $('#cron').cron({
 *    initial: '9 10 * * *', # Initial value. default = "* * * * *"
 *    url_set: '/set/', # POST expecting {"cron": "12 10 * * 6"}
 *  });
 *
 *  // you can update values later
 *  c.cron("value", "1 2 3 4 *");
 *
 * // you can also get the current value using the "value" option
 * alert(c.cron("value"));
 *
 *  (HTML)
 *  <div id='cron'></div>
 *
 * Notes:
 * At this stage, we only support a subset of possible cron options.
 * For example, each cron entry can only be digits or "*", no commas
 * to denote multiple entries. We also limit the allowed combinations:
 * - Every minute : * * * * *
 * - Every hour   : ? * * * *
 * - Every day    : ? ? * * *
 * - Every week   : ? ? * * ?
 * - Every month  : ? ? ? * *
 * - Every year   : ? ? ? ? *
 *//*jshint laxbreak:true */(function(a){function x(a){return typeof a=="undefined"?!1:!0}function y(a){return!x(a)||typeof a=="object"}function z(b){var c=/^([\d\,\*]+\s){4}[\d\,\*]+$/;if(typeof b!="string"||!c.test(b)){a.error("cron: invalid initial value");return undefined}var d=b.split(" "),e=[0,0,1,1,0],f=[59,23,31,12,6],g;for(var h=0;h<d.length;h++){if(d[h]==="*")continue;if(d[h].indexOf(",")>=0){var i=d[h].split(","),j=!1;for(var k=0;k<i.length;k++){g=parseInt(i[k],10);if(x(g)&&g<=f[h]&&g>=e[h])continue;j=!0}if(!j)continue}else{g=parseInt(d[h],10);if(x(g)&&g<=f[h]&&g>=e[h])continue}a.error("cron: invalid value found (col "+(h+1)+")");return undefined}for(var l in w)if(w[l].test(b))return l;a.error("cron: valid but unsupported cron format. sorry.");return undefined}function A(a,b){return x(z(b.initial))?y(b.customValues)?!1:!0:!0}function B(a){var b=a.data("block"),c=b.period.find("select").val(),d,e,f,g,h;d=e=f=g=h="*";switch(c){case"minute":break;case"hour":d=C(b.mins.find("select"));break;case"day":d=C(b.time.find("select.cron-time-min"));e=C(b.time.find("select.cron-time-hour"));break;case"week":d=C(b.time.find("select.cron-time-min"));e=C(b.time.find("select.cron-time-hour"));h=C(b.dow.find("select"));break;case"month":d=C(b.time.find("select.cron-time-min"));e=C(b.time.find("select.cron-time-hour"));f=C(b.dom.find("select"));break;case"year":d=C(b.time.find("select.cron-time-min"));e=C(b.time.find("select.cron-time-hour"));f=C(b.dom.find("select"));g=C(b.month.find("select"));break;default:return c}return[d,e,f,g,h].join(" ")}function C(b){var c;if(b.length>1){c=[];b.each(function(b,d){c.push(a(d).val())});return c.join(",")}return b.val()}function D(b,c){a.each(b,function(b,d){a(d).val(c[b]).gentleSelect("update")})}var b={initial:"* * * * *",minuteOpts:{minWidth:100,itemWidth:30,columns:4,rows:undefined,title:"Minutes Past the Hour"},timeHourOpts:{minWidth:100,itemWidth:20,columns:2,rows:undefined,title:"Time: Hour"},domOpts:{minWidth:100,itemWidth:30,columns:undefined,rows:10,title:"Day of Month"},monthOpts:{minWidth:100,itemWidth:100,columns:2,rows:undefined,title:undefined},dowOpts:{minWidth:100,itemWidth:undefined,columns:undefined,rows:undefined,title:undefined},timeMinuteOpts:{minWidth:100,itemWidth:20,columns:4,rows:undefined,title:"Time: Minute"},effectOpts:{openSpeed:400,closeSpeed:400,openEffect:"slide",closeEffect:"slide",hideOnMouseOut:!0},multiFrequency:!1,frequencyOpts:{1:"once",2:"twice",3:"three times",4:"four times"},url_set:undefined,customValues:undefined,onChange:undefined},c="";for(var d=0;d<60;d++){var e=d<10?"0":"";c+="<option value='"+d+"'>"+e+d+"</option>\n"}var f="";for(var g=0;g<24;g++){var h=g<12?"am":"pm",i=g>12?g-12:g;i===0&&(i=12);f+="<option value='"+g+"'>"+i+h+"</option>\n"}var j="";for(var k=1;k<32;k++){var l;k===1||k===21||k===31?l="st":k===2||k===22?l="nd":k===3||k===23?l="rd":l="th";j+="<option value='"+k+"'>"+k+l+"</option>\n"}var m="",n=["January","February","March","April","May","June","July","August","September","October","November","December"];for(var o=0;o<n.length;o++)m+="<option value='"+(o+1)+"'>"+n[o]+"</option>\n";var p="",q=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];for(var r=0;r<q.length;r++)p+="<option value='"+r+"'>"+q[r]+"</option>\n";var s="",t=["minute","hour","day","week","month","year"];for(var u=0;u<t.length;u++)s+="<option value='"+t[u]+"'>"+t[u]+"</option>\n";var v={minute:[],hour:["mins"],day:["time"],week:["dow","time"],month:["dom","time"],year:["dom","month","time"]},w={minute:/^(\*\s){4}\*$/,hour:/^^[\d\,]+\s(\*\s){3}\*$/,day:/^(\d{1,2}\s)[\d\,]+\s(\*\s){2}\*$/,week:/^(\d{1,2}\s){2}(\*\s){2}[\d\,]+$/,month:/^(\d{1,2}\s){2}[\d\,]+(\s\*){2}$/,year:/^(\d{1,2}\s){3}[\d\,]+\s\*$/},E={init:function(d){var e=d?d:{},g=a.extend([],b,e),h=a.extend({},b.effectOpts,e.effectOpts);a.extend(g,{minuteOpts:a.extend({},b.minuteOpts,h,e.minuteOpts),domOpts:a.extend({},b.domOpts,h,e.domOpts),monthOpts:a.extend({},b.monthOpts,h,e.monthOpts),dowOpts:a.extend({},b.dowOpts,h,e.dowOpts),timeHourOpts:a.extend({},b.timeHourOpts,h,e.timeHourOpts),timeMinuteOpts:a.extend({},b.timeMinuteOpts,h,e.timeMinuteOpts),multiFrequency:e.multiFrequency?e.multiFrequency:b.multiFrequency,frequencyOpts:e.frequencyOpts?e.frequencyOpts:b.frequencyOpts});if(A(this,g))return this;var i=[],k="",l=g.customValues;if(x(l))for(var n in l)l.hasOwnProperty(n)&&(k+="<option value='"+l[n]+"'>"+n+"</option>\n");if(g.multiFrequency){var o="";for(var q in g.frequencyOpts)g.frequencyOpts.hasOwnProperty(q)&&(o+="<option value='"+q+"'>"+g.frequencyOpts[q]+"</option>\n");i.frequency=a("<span class='cron-frequency'><select name='cron-frequency'>"+o+"</select> per </span>").appendTo(this).find("select").bind("change.cron",G.frequencyChanged).data("root",this).gentleSelect(h).end()}i.period=a("<span class='cron-period'><select name='cron-period'>"+k+s+"</select> </span>").appendTo(this).find("select").bind("change.cron",G.periodChanged).data("root",this).gentleSelect(h).end();i.dom=a("<span class='cron-block cron-block-dom'> on the <select name='cron-dom'>"+j+"</select> </span>").appendTo(this).data("root",this).find("select").gentleSelect(g.domOpts).data("root",this).end();i.month=a("<span class='cron-block cron-block-month'> of <select name='cron-month'>"+m+"</select> </span>").appendTo(this).data("root",this).find("select").gentleSelect(g.monthOpts).data("root",this).end();i.mins=a("<span class='cron-block cron-block-mins'> at <select name='cron-mins'>"+c+"</select> minutes past the hour </span>").appendTo(this).data("root",this).find("select").gentleSelect(g.minuteOpts).data("root",this).end();i.dow=a("<span class='cron-block cron-block-dow'> on <select name='cron-dow'>"+p+"</select> </span>").appendTo(this).data("root",this).find("select").gentleSelect(g.dowOpts).data("root",this).end();i.time=a("<span class='cron-block cron-block-time'> at <select name='cron-time-min' class='cron-time-min'>"+c+"</select> minutes past <select name='cron-time-hour' class='cron-time-hour'>"+f+"</select></span>").appendTo(this).data("root",this).find("select.cron-time-hour").gentleSelect(g.timeHourOpts).data("root",this).end().find("select.cron-time-min").gentleSelect(g.timeMinuteOpts).data("root",this).end();i.controls=a("<span class='cron-controls'>&laquo; save <span class='cron-button cron-button-save'></span> </span>").appendTo(this).data("root",this).find("span.cron-button-save").bind("click.cron",G.saveClicked).data("root",this).end();this.find("select").bind("change.cron-callback",G.somethingChanged);this.data("options",g).data("block",i);this.data("current_value",g.initial);return E.value.call(this,g.initial)},value:function(a){if(!a)return B(this);var b=z(a);if(!x(b))return!1;var c=this.data("block"),d=this.data("options"),e=a.split(" "),f={mins:e[0],hour:e[1],dom:e[2],month:e[3],dow:e[4]},g={minute:"",hour:{value:f.mins,name:"mins"},day:{value:f.hour,name:"hour"},week:{value:f.dow,name:"dow"},month:{value:f.dom,name:"dom"},year:{value:f.month,name:"month"}};c.period.find("select").val(b).gentleSelect("update").trigger("change");if(d.multiFrequency){var h=g[b].value.replace(/(^,)|(,$)/g,"");if(h.indexOf(",")>=0){var i=h.split(",");f[g[b].name]=i;c.frequency.find("select").val(i.length).gentleSelect("update").triggerHandler("change")}}var j=v[b];for(var k=0;k<j.length;k++){var l=j[k];if(l==="time"){D(c[l].find("select.cron-time-hour"),f.hour);D(c[l].find("select.cron-time-min"),f.mins)}else D(c[l].find("select"),f[l])}return this}},F={},G={frequencyChanged:function(){var b=a(this),c=b.data("root"),d=b.val(),e,f,g,h,i,j;c.find(".frequency-block").remove();if(d>0){e=c.data("options");switch(c.find('select[name="cron-period"]').val()){case"minute":return;case"hour":g=c.find('select[name="cron-mins"]').first();i=e.minuteOpts;j="mins";break;case"day":g=c.find('select[name="cron-time-hour"]').first();i=e.timeHourOpts;j="hour";break;case"week":g=c.find('select[name="cron-dow"]').first();i=e.dowOpts;j="dow";break;case"month":g=c.find('select[name="cron-dom"]').first();i=e.domOpts;j="dom";break;case"year":g=c.find('select[name="cron-month"]').first();i=e.monthOpts;j="month"}f=a('<span class="frequency-block" />').insertAfter(g);h=g.clone().wrap("<div>").parent().html();for(var k=d;k>1;k--)a('<span class="cron-block cron-block-'+j+'">'+(k===2?" and ":", ")+g.clone().wrap("<div>").parent().html()+"</span>").appendTo(f).find("select").data("root",c).bind("change.cron-callback",G.somethingChanged).gentleSelect(i).end()}return!0},periodChanged:function(){var b=a(this).data("root"),c=b.data("block"),d=b.data("options"),e=a(this).val();b.find("span.cron-block").hide();b.find(".frequency-block").remove();if(v.hasOwnProperty(e)){var f=v[a(this).val()];for(var g=0;g<f.length;g++)c[f[g]].show()}b.find('select[name="cron-frequency"]').first().trigger("change.cron")},somethingChanged:function(){var b=a(this).data("root");if(x(b.data("options").url_set))if(E.value.call(b)!==b.data("current_value")){b.addClass("cron-changed");b.data("block").controls.fadeIn()}else{b.removeClass("cron-changed");b.data("block").controls.fadeOut()}else b.data("block").controls.hide();var c=b.data("options").onChange;x(c)&&a.isFunction(c)&&c.call(b)},saveClicked:function(){var b=a(this),c=b.data("root"),d=E.value.call(c);if(b.hasClass("cron-loading"))return;b.addClass("cron-loading");a.ajax({type:"POST",url:c.data("options").url_set,data:{cron:d},success:function(){c.data("current_value",d);b.removeClass("cron-loading");if(d===E.value.call(c)){c.removeClass("cron-changed");c.data("block").controls.fadeOut()}},error:function(){window.alert("An error occured when submitting your request.");b.removeClass("cron-loading")}})}};a.fn.cron=function(b){if(E[b])return E[b].apply(this,Array.prototype.slice.call(arguments,1));if(typeof b=="object"||!b)return E.init.apply(this,arguments);a.error("Method "+b+" does not exist on jQuery.cron")}})(jQuery);